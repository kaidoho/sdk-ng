From 3a2ff57a99749dc753c00fa0e94ec966884edcdb Mon Sep 17 00:00:00 2001
From: kaidoho <kho237115@gmail.com>
Date: Sun, 16 Feb 2020 15:47:11 +0100
Subject: [PATCH] Add Zephyr OS

---
 libatomic/config/zephyr/host-config.h | 41 +++++++++++++++++++++++++++
 libatomic/config/zephyr/lock.c        | 37 ++++++++++++++++++++++++
 libatomic/configure.tgt               |  5 ++++
 libstdc++-v3/configure.host           |  4 +++
 4 files changed, 87 insertions(+)
 create mode 100644 libatomic/config/zephyr/host-config.h
 create mode 100644 libatomic/config/zephyr/lock.c

diff --git a/libatomic/config/zephyr/host-config.h b/libatomic/config/zephyr/host-config.h
new file mode 100644
index 000000000..05cfdb882
--- /dev/null
+++ b/libatomic/config/zephyr/host-config.h
@@ -0,0 +1,41 @@
+/* Copyright (C) 2016-2020 Free Software Foundation, Inc.
+   Contributed by Markus Bernd Moessner <kho237115@gmail.com>.
+
+   This file is part of the GNU Atomic Library (libatomic).
+
+   Libatomic is free software; you can redistribute it and/or modify it
+   under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   Libatomic is distributed in the hope that it will be useful, but WITHOUT ANY
+   WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+   FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+   more details.
+
+   Under Section 7 of GPL version 3, you are granted additional
+   permissions described in the GCC Runtime Library Exception, version
+   3.1, as published by the Free Software Foundation.
+
+   You should have received a copy of the GNU General Public License and
+   a copy of the GCC Runtime Library Exception along with this program;
+   see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see
+   <http://www.gnu.org/licenses/>.  */
+
+/* Included after all more target-specific host-config.h.  */
+
+#include <machine/_libatomic.h>
+
+static inline UWORD
+protect_start (void *ptr)
+{
+  return _z_libatomic_protect_start (ptr);
+}
+
+static inline void
+protect_end (void *ptr, UWORD isr_level)
+{
+  _z_libatomic_protect_end (ptr, isr_level);
+}
+
+#include_next <host-config.h>
diff --git a/libatomic/config/zephyr/lock.c b/libatomic/config/zephyr/lock.c
new file mode 100644
index 000000000..b9dc73ea9
--- /dev/null
+++ b/libatomic/config/zephyr/lock.c
@@ -0,0 +1,37 @@
+/* Copyright (C) 2016-2020 Free Software Foundation, Inc.
+   Contributed by Markus Bernd Moessner <kho237115@gmail.com>.
+
+   This file is part of the GNU Atomic Library (libatomic).
+
+   Libatomic is free software; you can redistribute it and/or modify it
+   under the terms of the GNU General Public License as published by
+   the Free Software Foundation; either version 3 of the License, or
+   (at your option) any later version.
+
+   Libatomic is distributed in the hope that it will be useful, but WITHOUT ANY
+   WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
+   FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
+   more details.
+
+   Under Section 7 of GPL version 3, you are granted additional
+   permissions described in the GCC Runtime Library Exception, version
+   3.1, as published by the Free Software Foundation.
+
+   You should have received a copy of the GNU General Public License and
+   a copy of the GCC Runtime Library Exception along with this program;
+   see the files COPYING3 and COPYING.RUNTIME respectively.  If not, see
+   <http://www.gnu.org/licenses/>.  */
+
+#include "libatomic_i.h"
+
+void
+libat_lock_n (void *ptr, size_t n)
+{
+  _z_libatomic_lock_n (ptr, n);
+}
+
+void
+libat_unlock_n (void *ptr, size_t n)
+{
+  _z_libatomic_unlock_n (ptr, n);
+}
diff --git a/libatomic/configure.tgt b/libatomic/configure.tgt
index ecbb7d33c..e8a31edc4 100644
--- a/libatomic/configure.tgt
+++ b/libatomic/configure.tgt
@@ -158,6 +158,11 @@ case "${target}" in
 	XCFLAGS="${configure_tgt_pre_target_cpu_XCFLAGS}"
 	config_path="rtems"
 	;;
+	
+  *-*-zephyr*)
+	XCFLAGS="${configure_tgt_pre_target_cpu_XCFLAGS}"
+	config_path="zephyr"
+	;;
 
   *-*-elf*)
 	# ??? No target OS.  We could be targeting bare-metal kernel-mode,
diff --git a/libstdc++-v3/configure.host b/libstdc++-v3/configure.host
index f2ff1295d..72b0db3d5 100644
--- a/libstdc++-v3/configure.host
+++ b/libstdc++-v3/configure.host
@@ -318,6 +318,10 @@ case "${host_os}" in
   vxworks)
     os_include_dir="os/vxworks"
     ;;
+  zephyr*)
+    # Use libatomic if necessary and avoid libstdc++ specific atomicity support
+    atomicity_dir="cpu/generic/atomicity_builtins"
+    ;;
   *)
     os_include_dir="os/generic"
     ;;
-- 
2.17.1

